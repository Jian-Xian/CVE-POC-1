# CVE-2019-15911 - Insecue key transport 

## Description

   An issue was discovered on ASUS HG100, MW100, WS-101, TS-101, AS-101, MS-101, DL-101 devices using ZigBee PRO.
   
   Because of insecure key transport in ZigBee communication, attackers can obtain sensitive information, cause the denial of service attacks, take over smart home devices, and tamper with messages.
   
   The security of ZigBee transmission data is mostly based on network key for data encryption, and the network key of the devices we tested that use the default trust center link key to encrypt the transmission of the network key. The default trust center link key is disclosed for years ago. We can gain sensitive information, tamper with messages, take over the smart home devices, denial of service attack when got the network key.

## ASUS smart home devices attack demonstration
### 1. System architecture
   The system architecture of this research attack demonstration, as shown in Figure 1, is divided into attacker and victim.

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/arch.jpg" width="50%" height="50%" />
 
Figure 1. Architecture of the attack demonstration
</center></div>
Attacker：

  1.	Laptop（Ubuntu 16.04.3 LTS）
  2.	Atmel RZ Raven USB sticks（2.4 GHz dongle）
  3.	KillerBee （Research mainly modifies the KillerBee API）
  4.	Zigdiggity  
  5.	Wireshark

Victim：	

  The environment of the victims is that the gateway acts as a ZigBee coordinator and is responsible for accessing the Internet,   establishing a ZigBee network, and connecting to the end devices and router. The users obtain the messages of the end devices or router  by using smart devices（e.g. smart phone…）. The victim devices of this attack demonstration use ASUS smart home devices. 
Their model:
  1.	Gateway acts as ZigBee coordinator：HG100 
  2.	Router：MW100
  3.	End device：WS-101
  4.	End device：TS-101
  5.	End device：AS-101
  6.	End device：MS-101
  7.	End device：DL-101

## 2. Key sniffing
---
### 2.1 Passive key sniffing
  After the attackers sniff the messages paired with the end devices or router, they can use the default trust center link key to decrypt key transport message to obtain the network key, as shown in Figure 2.

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-2.png" width="50%" height="50%" /> 
   
Figure 2. Passive key sniffing
</center></div>

### 2.2 Active key sniffing
The attackers send the fake rejoin requests of the end device or router. After the end device or router sends messages during the attack, it will be to rejoin the network. After the attackers sniff the rejoin network messages with the end device or router, they can use the default trust center link key to decrypt key transport message to obtain the network key, as shown in Figure 3.

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-3.png" width="50%" height="50%" /> 
   
Figure 3. Active key sniffing
</center></div>

## 3. Tamper with messages

   The attackers check the security level in current ZigBee network. The message integrity code is four bytes and the data is encrypted, as shown in Figure 4, so the security level identifier is 0x05, as shown in Figure 5. After determining the security level, the attackers can make the fake messages by modifying the value of the frame counter to be greater than the current frame counter value and adding security level information to perform AES CCM* encryption. After the encryption is completed, the security level of the fake messages is changed to 0 and transmitted to the ZigBee network, which can be successfully affected, as shown in Figure 6 and Figure 7.
   
   All devices were be affected that we test, except the DL-101 (door lock) it’s not real-time reacted, but if we keep sending messages to the DL-101 that it’s still reacted within 1 minute. So we still can control the door lock open or close. Or just change the state of the app.
   
   We test another architecture, as shown in Figure 8. We send the fake messages to router forward to the door lock, it can real-time reacted.
   
   When the attack is successful, the user cannot use the app to control the MW100 (Smart Plug) and DL-101, but we discovered the display status of the app will still change.

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-4.png" width="50%" height="50%" /> 
   
Figure 4. Security level check
</center></div>

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-5.png" width="50%" height="50%" /> 
   
Figure 5. Security level
</center></div>

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-6.png" width="50%" height="50%" /> 
   
Figure 6. TS-101 was tampered with messagesurity level check
</center></div>

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-7.png" width="50%" height="50%" /> 
   
Figure 7. WS-101 was tampered with messages
   </center></div>

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-8.png" width="50%" height="50%" /> 
   
Figure 8. Architecture of the attack demonstration_2
   </center></div>
   
## 4. Denial of Service Attack
### 4.1 Maximum frame counter

The attackers send the fake encrypted packet to the coordinator. The frame counter value of the fake packet is close to the maximum value of 0xFFFFFFAA, as shown in Figure 8. Although the coordinator will still respond to the packet, the value of the frame counter transmitted by the end device or router is less than the value currently recorded by the coordinator, the packet will not be received, as shown in figure 9. The state displayed by the user's smart device on its end device or router will also not be updated.
Users don't control DL-101 or MW100 open or close with the smart devices, but the smart device still changes his state when the coordinator not received DL-101 or MW100 state.

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-9.png" width="50%" height="50%" /> 
   
Figure 9. Maximum frame counter - 1
</center></div>

<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-10.png" width="50%" height="50%" /> 
   
Figure 10. Maximum frame counter - 2
</center></div>

### 4.2 Insecure leave network procedure

The attackers send the fake encrypted leave packet that leaves the network to the coordinator. After the coordinator receives it, it will broadcast leave the current network. If the other end devices or router transmit messages to the coordinator, it will be no response, as shown in Figure 11.


<div align=center>
<center>
<img src="https://github.com/chengcheng227/CVE-POC-TEST/blob/master/picture/15911-11.png" width="50%" height="50%" /> 
   
Figure 11. Insecure leave network procedure
</center></div>

